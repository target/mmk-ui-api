{{define "secret-form-content"}}
<div class="secrets-section">
    <div class="card">
        <div class="card-header">
            <a class="btn btn-secondary"
               href="/secrets"
               hx-get="/secrets"
               hx-target="#main-content"
               hx-swap="innerHTML"
               hx-push-url="true">Back</a>
        </div>
        <div class="card-body">
            {{ template "error-banner" . }}
        {{/* Form */}}
    <form id="secret-form"
          method="post"
          action="{{if eq .Mode "edit"}}/secrets/{{index .Secret "ID"}}{{else}}/secrets{{end}}"
          hx-post="{{if eq .Mode "edit"}}/secrets/{{index .Secret "ID"}}{{else}}/secrets{{end}}"
          hx-target="#main-content"
          hx-swap="innerHTML"
          hx-push-url="true">
    {{/* Name */}}
    <div class="form-group">
        <label for="name">Name</label>
        <input id="name"
               name="name"
               type="text"
               class="input mono"
               value="{{if .FormName}}{{.FormName}}{{else}}{{if eq .Mode "edit"}}{{index .Secret "Name"}}{{end}}{{end}}"
               required
               pattern="[A-Za-z0-9_][A-Za-z0-9_\-]*"
               maxlength="255"
               aria-describedby="name-help">
        <small id="name-help">Single word. Letters, digits, underscore, and hyphens.</small>
        {{with (index .Errors "name")}}
        <div class="field-error">{{.}}</div>
        {{end}}
    </div>
{{/* Secret value (create) or replace (edit) */}}
{{if eq .Mode "create"}}
<div class="form-group" data-secret-value-group>
    <label for="secret-value">
        Secret <span class="text-muted" data-optional-hint hidden>(optional when using refresh script)</span>
    </label>
    <textarea id="secret-value"
              name="value"
              class="input secret-textarea mono"
              rows="4"
              autocomplete="new-password"
              placeholder="Enter your secret value..."
              required
              data-value-required></textarea>
    <small class="text-muted" data-refresh-hint hidden>Leave empty to populate from refresh script on first run.</small>
    {{with (index .Errors "value")}}
    <div class="field-error">{{.}}</div>
    {{end}}
</div>
{{else}}
<div class="form-group">
    <label>
        <input type="checkbox" name="replace" value="1" data-action="toggle-replace">
        Replace secret
    </label>
    <div data-secret-input hidden class="secret-replacement-container">
        <div class="secret-input-container">
            <textarea id="secret-value"
                      name="value"
                      class="input secret-textarea secret-hidden"
                      rows="4"
                      autocomplete="new-password"
                      disabled
                      placeholder="Enter your secret value..."
                      required
                      data-secret-input-target></textarea>
            <div class="secret-input-actions">
                <button type="button"
                        class="btn btn-secondary btn-sm secret-toggle-btn"
                        data-action="toggle-secret"
                        aria-controls="secret-value"
                        aria-pressed="false">Show Typed Value</button>
                <button type="button"
                        class="btn btn-secondary btn-sm secret-reveal-btn"
                        data-action="reveal-secret"
                        data-secret-reveal-url="/api/secrets/{{index .Secret "ID"}}"
                        aria-pressed="false"
                        aria-controls="secret-current-value">Reveal Current Secret</button>
            </div>
        </div>
        <div class="secret-reveal" data-secret-reveal hidden>
            <textarea class="input secret-textarea secret-reveal-value"
                      id="secret-current-value"
                      rows="4"
                      readonly
                      data-secret-display></textarea>
            <small class="text-muted" data-secret-countdown hidden></small>
        </div>
        <div class="field-error" data-secret-error hidden aria-live="polite"></div>
        {{with (index .Errors "value")}}
        <div class="field-error">{{.}}</div>
        {{end}}
    </div>
</div>
{{end}}
{{/* Refresh Configuration Section */}}
<div class="form-section">
    <h3>
        Dynamic Secret Configuration <span class="text-muted">(optional)</span>
    </h3>
    <p class="text-muted">Configure automatic refresh using a provider script.</p>
{{/* Refresh Enabled Checkbox */}}
<div class="form-group">
    <label>
        <input type="checkbox" name="refresh_enabled" value="1" {{if .FormRefreshEnabled}}checked{{else}}{{if eq .Mode "edit"}}{{if index .Secret "RefreshEnabled"}}checked{{end}}{{end}}{{end}} data-action="toggle-refresh-config">
        Enable automatic refresh
    </label>
</div>
{{/* Refresh Configuration Fields */}}
<div data-refresh-config {{if not (or .FormRefreshEnabled (and (eq .Mode "edit") (index .Secret "RefreshEnabled")))}}hidden{{end}}>
{{/* Provider Script Path */}}
<div class="form-group">
    <label for="provider-script-path">Provider Script Path</label>
    <input id="provider-script-path"
           name="provider_script_path"
           type="text"
           class="input mono"
           value="{{if .FormProviderScript}}{{.FormProviderScript}}{{else}}{{if eq .Mode "edit"}}{{index .Secret "ProviderScriptPath"}}{{end}}{{end}}"
           placeholder="/path/to/script.sh"
           maxlength="500"
           aria-describedby="provider-script-help">
    <small id="provider-script-help">Absolute path to executable script that fetches the secret value.</small>
    {{with (index .Errors "provider_script_path")}}
    <div class="field-error">{{.}}</div>
    {{end}}
</div>
{{/* Environment Config */}}
<div class="form-group">
    <label for="env-config">
        Environment Variables <span class="text-muted">(optional)</span>
    </label>
    <textarea id="env-config"
              name="env_config"
              class="input mono"
              rows="4"
              placeholder='{"API_URL": "https://api.example.com", "CLIENT_ID": "your-client-id"}'
              aria-describedby="env-config-help">{{if .FormEnvConfig}}{{.FormEnvConfig}}{{else}}{{if eq .Mode "edit"}}{{index .Secret "EnvConfig"}}{{end}}{{end}}</textarea>
    <small id="env-config-help">JSON object with environment variables passed to the provider script.</small>
    {{with (index .Errors "env_config")}}
    <div class="field-error">{{.}}</div>
    {{end}}
</div>
{{/* Refresh Interval */}}
<div class="form-group">
    <label for="refresh-interval">Refresh Interval (minutes)</label>
    <input id="refresh-interval"
           name="refresh_interval_minutes"
           type="number"
           class="input"
           min="1"
           max="10080"
           step="any"
           value="{{if .FormRefreshInterval}}{{.FormRefreshInterval}}{{else}}{{if eq .Mode "edit"}}{{index .Secret "RefreshInterval"}}{{end}}{{end}}"
           placeholder="60"
           aria-describedby="refresh-interval-help">
    <small id="refresh-interval-help">How often to refresh the secret (minimum 1 minute, maximum 7 days / 10080 minutes).</small>
    {{with (index .Errors "refresh_interval_minutes")}}
    <div class="field-error">{{.}}</div>
    {{end}}
</div>
</div>
</div>
{{/* Refresh Status (Edit Mode Only) */}}
{{if eq .Mode "edit"}}
{{if index .Secret "RefreshEnabled"}}
<div class="form-section">
    <h3>Refresh Status</h3>
    <div class="status-grid">
        {{if index .Secret "LastRefreshedAt"}}
        <div class="status-item">
            <label>Last Refreshed</label>
            <span>{{index .Secret "LastRefreshedAt" | friendlyTime}}</span>
        </div>
        {{end}}
        {{if index .Secret "LastRefreshStatus"}}
        <div class="status-item">
            <label>Status</label>
        <span class="badge {{if eq (index .Secret "LastRefreshStatus") "success"}}badge-success{{else}}badge-error{{end}}">
            {{index .Secret "LastRefreshStatus"}}
        </span>
    </div>
    {{end}}
    {{if index .Secret "LastRefreshError"}}
    <div class="status-item">
        <label>Last Error</label>
        <span class="text-error">{{index .Secret "LastRefreshError"}}</span>
    </div>
    {{end}}
</div>
</div>
{{end}}
{{end}}
<div class="form-actions">
    <button type="submit" class="btn btn-primary">Save</button>
    <a class="btn btn-secondary"
       href="/secrets"
       hx-get="/secrets"
       hx-target="#main-content"
       hx-swap="innerHTML"
       hx-push-url="true">Cancel</a>
</div>
</form>
</div>
</div>
</div>
{{end}}
