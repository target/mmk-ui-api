{{ define "source-form-content" }}
<div class="source-form-section">
    <div class="card">
        <div class="card-header">
            <a class="btn btn-secondary"
               href="/sources"
               hx-get="/sources"
               hx-target="#main-content"
               hx-swap="innerHTML"
               hx-push-url="true">Back</a>
        </div>
        <div class="card-body" data-component="source-form">
            {{ template "error-banner" . }}
            <form id="source-form"
                  hx-post="/sources"
                  hx-target="#main-content"
                  hx-swap="innerHTML"
                  hx-push-url="true">
                <input type="hidden"
                       id="client_token"
                       name="client_token"
                       value="{{.ClientToken}}" />
                <div class="form-group">
                    <label for="name">Name</label>
                    <div class="max-w-md">
                        <input id="name"
                               name="name"
                               type="text"
                               class="input max-w-md"
                               value="{{.FormName}}"
                               maxlength="255"
                               placeholder="e.g., my-source" />
                        <small>Required for Create. For Test, a unique name is generated if empty.</small>
                        {{ with index .Errors "name" }}
                        <div class="field-error">{{.}}</div>
                        {{ end }}
                    </div>
                </div>
                <div class="form-group">
                    <label for="secrets">
                        Secrets <span class="text-muted">(optional)</span>
                    </label>
                    <select id="secrets" name="secrets" class="input max-w-md" multiple size="4">
                        {{ range .SecretOptions }}
                        <option value="{{.Name}}" {{ if .Selected }}selected{{ end }}>{{.Name}}
                        </option>
                        {{ end }}
                    </select>
                    <small>Use placeholders like __SECRET_NAME__ inside your script.</small>
                </div>
                <div class="form-group">
                    <label for="value">Source Script</label>
                    <textarea id="value"
                              name="value"
                              class="input mono"
                              rows="10"
                              placeholder="Paste your Puppeteer script here...">{{.FormValue}}</textarea>
                    {{ with index .Errors "value" }}
                    <div class="field-error">{{.}}</div>
                    {{ end }}
                </div>
                <div class="form-actions row gap-3">
                    <button type="submit" id="btn-create" class="btn btn-primary">Create</button>
                    <button type="button"
                            class="btn"
                            id="btn-test"
                            hx-post="/sources/test"
                            hx-include="#source-form"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="false">Test</button>
                </div>
            </form>
            <div id="source-test-panel" class="source-test-panel" {{ if not .TestRunning }} hidden {{ end }} data-source-id="{{.TestSourceID}}" data-job-id="{{.TestJobID}}" data-client-token="{{.ClientToken}}">
                {{ if .TestJobID }}
                <div id="test-status"
                     class="mb-3"
                     hx-get="/sources/test/{{.TestJobID}}/status"
                     hx-trigger="load, every 2s"
                     hx-swap="outerHTML">
                    <div class="flex-center gap-2" style="flex-wrap:wrap;">
                        <span class="status-badge status-badge--pending">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            Loading
                        </span>
                        <span class="badge-secondary mono text-xs"
                              style="margin-left:auto;
                                     cursor:help"
                              title="Job ID: {{.TestJobID}}">{{truncateText .TestJobID 8}}</span>
                    </div>
                </div>
            {{ else }}
                <div id="test-status" class="mb-3">
                    <div class="flex-center gap-2" style="flex-wrap:wrap;">
                        <span class="status-badge status-badge--pending">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            Waiting
                        </span>
                        <span class="small text-muted">Initializing test job...</span>
                    </div>
                </div>
                {{ end }}
                <div class="test-events-scroll"
                     aria-label="Test events stream"
                     role="region">
                    <div class="test-event-filters mb-3"
                         data-role="event-filters"
                         aria-label="Filter test events by type">
                        <div class="test-event-filters__header">
                            <span class="test-event-filters__title">Event types</span>
                            <span class="test-event-filters__summary text-muted text-xs"
                                  data-role="event-filter-summary">All event types</span>
                        </div>
                        <div class="test-event-filters__pills"
                             role="group"
                             aria-label="Toggle event types">
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter test-event-filter--all active"
                                    data-filter="all"
                                    data-state="all"
                                    aria-pressed="true">
                                <span class="test-event-filter__label">All</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="screenshot"
                                    aria-pressed="true">
                                <span class="event__summary-tag event__summary-tag--screenshot">shot</span>
                                <span class="test-event-filter__label">Screenshots</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="network"
                                    aria-pressed="true">
                                <span class="event__summary-tag event__summary-tag--requestWillBeSent">net</span>
                                <span class="test-event-filter__label">Network</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="console"
                                    aria-pressed="true">
                                <span class="event__summary-tag event__summary-tag--console">log</span>
                                <span class="test-event-filter__label">Console</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="action"
                                    aria-pressed="true">
                                <span class="event__summary-tag event__summary-tag--page">act</span>
                                <span class="test-event-filter__label">Actions</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="page"
                                    aria-pressed="true">
                                <span class="event__summary-tag event__summary-tag--page">nav</span>
                                <span class="test-event-filter__label">Page</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="security"
                                    aria-pressed="true">
                                <span class="event__summary-tag event__summary-tag--security">sec</span>
                                <span class="test-event-filter__label">Security</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="worker_log"
                                    aria-pressed="true">
                                <span class="event__summary-tag event__summary-tag--worker">log</span>
                                <span class="test-event-filter__label">Worker Logs</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="job_failure"
                                    aria-pressed="true">
                                <span class="event__summary-tag event__summary-tag--job">fail</span>
                                <span class="test-event-filter__label">Job Failures</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="error"
                                    aria-pressed="true">
                                <span class="event__summary-tag event__summary-tag--error">err</span>
                                <span class="test-event-filter__label">Errors</span>
                            </button>
                            <button type="button"
                                    class="filter-pill filter-pill--compact test-event-filter active"
                                    data-category="other"
                                    aria-pressed="true">
                                <span class="event__summary-tag">other</span>
                                <span class="test-event-filter__label">Other</span>
                            </button>
                        </div>
                    </div>
                    {{ if .TestJobID }}
                    <div id="test-events"
                         class="test-events"
                         data-job-id="{{.TestJobID}}"
                         data-since="0"></div>
                {{ else }}
                    <div id="test-events" class="test-events"></div>
                    {{ end }}
                </div>
            </div>
        </div>
    </div>
</div>
{{ end }}
