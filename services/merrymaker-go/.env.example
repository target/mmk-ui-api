# ==============================================================================
# MERRYMAKER CONFIGURATION
# ==============================================================================
# Copy this file to .env and customize for your environment.
#
# This .env file is the single source of truth for local development.
# Both Air (live-reload) and direct `go run` commands load config from this file.
# No need to maintain duplicate environment configs in .air.toml.
# ==============================================================================

# ==============================================================================
# ENVIRONMENT MODE
# ==============================================================================

# Development mode - enables hot reloading for templates and static assets
# Accepts 1/true (case-insensitive). If DEV is not truthy, NODE_ENV=development/dev enables the same behavior.
# DEV=true takes precedence over NODE_ENV.
DEV=true

# ==============================================================================
# AUTHENTICATION
# ==============================================================================

# Authentication mode: oauth or mock
# - oauth: Use OAuth/OIDC for authentication (production)
# - mock: Use mock/dev authentication (development only)
AUTH_MODE=mock

# --- OAuth/OIDC Configuration (used when AUTH_MODE=oauth) ---

# OAuth client ID (provided by your OAuth provider)
OAUTH_CLIENT_ID=merrymaker

# OAuth client secret (provided by your OAuth provider)
OAUTH_CLIENT_SECRET=merrymaker

# OAuth redirect URL (must match the URL registered with your OAuth provider)
OAUTH_REDIRECT_URL=http://localhost:8080/auth/callback

# OAuth scope (space-separated list of scopes to request)
OAUTH_SCOPE=openid profile email groups

# OAuth discovery URL (OIDC discovery endpoint)
# Example: https://oauth.example.com/.well-known/openid-configuration
OAUTH_DISCOVERY_URL=

# OAuth logout URL (optional, for single sign-out)
OAUTH_LOGOUT_URL=

# --- Dev/Mock Authentication (used when AUTH_MODE=mock) ---

# Mock user ID for development
DEV_AUTH_USER_ID=dev-user

# Mock user email for development
DEV_AUTH_EMAIL=dev@example.com

# Mock user groups for development (semicolon-separated)
# Set to admin group DN to get admin role in mock mode
DEV_AUTH_GROUPS=CN=APP-Oauth2-MerryMaker-Admin,OU=Application,OU=Groupings,DC=corp,DC=target,DC=com

# --- Role Mappings (required) ---

# LDAP/AD group DN for admin users
# Users in this group have full administrative access
ADMIN_GROUP=CN=APP-Oauth2-MerryMaker-Admin,OU=Application,OU=Groupings,DC=corp,DC=target,DC=com

# LDAP/AD group DN for regular users
# Users in this group have read-only access
USER_GROUP=CN=APP-Oauth2-MerryMaker-User,OU=Application,OU=Groupings,DC=corp,DC=target,DC=com

# ==============================================================================
# DATABASE
# ==============================================================================

# PostgreSQL database host
DB_HOST=localhost

# PostgreSQL database port
DB_PORT=5432

# PostgreSQL database user
DB_USER=merrymaker

# PostgreSQL database password
DB_PASSWORD=merrymaker

# PostgreSQL database name
DB_NAME=merrymaker

# PostgreSQL SSL mode: disable, require, verify-ca, verify-full
# Use 'disable' for local development, 'require' or higher for production
DB_SSL_MODE=disable
# Control whether the application runs migrations automatically on startup
DB_RUN_MIGRATIONS_ON_START=true

# ==============================================================================
# REDIS
# ==============================================================================

# Redis URI (host:port or redis:// URL)
# Supports redis:// (plaintext) and rediss:// (TLS) endpoints with optional credentials.
# Examples:
#   REDIS_URI=localhost:6379
#   REDIS_URI=redis://default:secret@redis.internal:6379/0
#   REDIS_URI=rediss://default:secret@redis.example.com:6380/1
REDIS_URI=localhost:6379

# Redis password (leave empty if no password)
REDIS_PASSWORD=

# --- Redis Sentinel Configuration (optional, for high availability) ---

# Enable Redis Sentinel mode
REDIS_USE_SENTINEL=false

# Redis Sentinel port
REDIS_SENTINEL_PORT=26379

# Redis Sentinel nodes (comma-separated list of host:port)
# Note: Use Sentinel port (26379), not Redis server port (6379)
REDIS_SENTINEL_NODES=localhost:26379

# Redis Sentinel master name
REDIS_SENTINEL_MASTER_NAME=mymaster

# Redis Sentinel password (leave empty if no password)
REDIS_SENTINEL_PASSWORD=

# --- Redis Cluster Configuration (optional, for sharded deployments) ---

# Enable Redis Cluster mode
REDIS_USE_CLUSTER=false

# Redis Cluster node addresses (comma-separated list of host:port)
# Empty entries are ignored to support 12-factor style env tooling.
# Example:
#   REDIS_CLUSTER_NODES=redis-cluster-0:6379,redis-cluster-1:6379,redis-cluster-2:6379
REDIS_CLUSTER_NODES=


# ==============================================================================
# CACHE
# ==============================================================================

# Redis address for cache (can be different from main Redis)
CACHE_REDIS_ADDR=localhost:6379

# Redis password for cache
CACHE_REDIS_PASSWORD=

# Redis database number for cache (0-15)
CACHE_REDIS_DB=0

# TTL for cached source content (e.g., 30m, 1h, 24h)
CACHE_SOURCE_TTL=30m

# ==============================================================================
# SECRETS ENCRYPTION
# ==============================================================================

# Encryption key for secrets storage (32 bytes, base64-encoded)
# Required for production, recommended for development (to avoid warnings)
# Generate with: openssl rand -base64 32
# Example (DO NOT use this in production):
#   SECRETS_ENCRYPTION_KEY=ANyewnNOtvtI7wR3aLk9YvvKXgBeOiKYI68DbnKADtA=  # base64-encoded 32-byte key (44 chars with padding)
SECRETS_ENCRYPTION_KEY=

# ==============================================================================
# HTTP SERVER
# ==============================================================================

# HTTP server bind address
# Use :8080 to bind to all interfaces, localhost:8080 for local only
HTTP_ADDR=:8080

# Cookie domain for session cookies
# Leave empty to use the request domain
APP_COOKIE_DOMAIN=

# Enable gzip compression for text-based assets (HTML, CSS, JS)
# Recommended for production, optional for local development
HTTP_COMPRESSION_ENABLED=true

# Gzip compression level (1-9)
# 1 = fastest/least compression, 9 = slowest/most compression
# 6 = standard gzip default (good balance)
HTTP_COMPRESSION_LEVEL=6

# ==============================================================================
# SERVICE MODE
# ==============================================================================

# Comma-delimited list of services to enable
# Valid values: http, rules-engine, scheduler, reaper
# Examples:
#   - http                                  (HTTP server only)
#   - http,scheduler                        (HTTP server + job scheduler)
#   - http,rules-engine,scheduler,reaper    (all services)
#   - rules-engine                          (rules engine worker only)
#   - reaper                                (job cleanup service only)
SERVICES=http,scheduler,rules-engine

# ==============================================================================
# SCHEDULER SERVICE
# ==============================================================================

# Number of jobs to schedule per batch
SCHEDULER_BATCH_SIZE=25

# Default job type for scheduled jobs
# Valid values: browser, api, custom
SCHEDULER_DEFAULT_JOB_TYPE=browser

# Default priority for scheduled jobs (higher = higher priority)
SCHEDULER_DEFAULT_PRIORITY=0

# Maximum number of retries for failed jobs
SCHEDULER_MAX_RETRIES=3

# Overrun policy: how to handle jobs that overrun their schedule
# Valid values:
#   - skip: Skip the overrun job (default)
#   - queue: Queue the overrun job for later execution
#   - reschedule: Reschedule the overrun job
SCHEDULER_OVERRUN=skip

# Scheduler tick interval (how often to check for jobs to schedule)
# Examples: 1s, 5s, 10s, 1m
SCHEDULER_INTERVAL=1s

# ==============================================================================
# RULES ENGINE SERVICE
# ==============================================================================

# Number of worker goroutines for rules engine
# Increase for higher throughput (be mindful of CPU/memory)
RULES_ENGINE_CONCURRENCY=1

# Job lease duration for rules engine jobs
# How long a worker can hold a job before it's considered stale
RULES_ENGINE_JOB_LEASE=30s

# Maximum number of events to process per rules job
RULES_ENGINE_BATCH_SIZE=100

# Auto-enqueue rules jobs on event ingestion
# Set to false to manually trigger rules processing
RULES_ENGINE_AUTO_ENQUEUE=true

# ==============================================================================
# REAPER SERVICE (Job Cleanup)
# ==============================================================================

# Reaper tick interval (how often to run cleanup operations)
# Recommended: 5m for production, 1m for development
# Examples: 1m, 5m, 15m, 1h
REAPER_INTERVAL=5m

# Maximum age for pending jobs before they are marked as failed
# Jobs stuck in pending status longer than this will be failed
# Recommended: 1h for production, 30m for development
# Examples: 30m, 1h, 2h
REAPER_PENDING_MAX_AGE=1h

# Maximum age for completed jobs before deletion
# Completed jobs older than this will be deleted to prevent database bloat
# Recommended: 168h (7 days) for production, 24h for development
# Examples: 24h, 168h (7 days), 720h (30 days)
REAPER_COMPLETED_MAX_AGE=168h

# Maximum age for failed jobs before deletion
# Failed jobs older than this will be deleted to prevent database bloat
# Recommended: 168h (7 days) for production, 24h for development
# Examples: 24h, 168h (7 days), 720h (30 days)
REAPER_FAILED_MAX_AGE=168h

# Batch size for cleanup operations
# Maximum number of rows to process per operation to prevent long locks
# Recommended: 1000 for most cases, lower for high-traffic databases
# Examples: 100, 500, 1000, 5000
REAPER_BATCH_SIZE=1000

# ==============================================================================
# SECRET REFRESH RUNNER SERVICE
# ==============================================================================

# Number of worker goroutines for secret refresh runner
# Increase for higher throughput (be mindful of CPU/memory)
SECRET_REFRESH_RUNNER_CONCURRENCY=2

# Job lease duration for secret refresh jobs
# How long a worker can hold a job before it's considered stale
SECRET_REFRESH_RUNNER_JOB_LEASE=30s

# [WARNING] Debug mode for secret refresh jobs
# When enabled, actual secret values will be logged to stdout/logs
# This is a SECURITY RISK and should NEVER be enabled in production
# Only enable for local debugging of secret refresh issues
# Valid values: true, false
SECRET_REFRESH_DEBUG_MODE=false
